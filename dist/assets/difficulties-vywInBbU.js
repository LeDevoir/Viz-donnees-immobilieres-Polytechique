import"./styles-DoX-3eds.js";let T,I,y=null,L,B;document.addEventListener("DOMContentLoaded",function(){I=document.getElementById("mapSvg"),L=document.getElementById("legendSvg");const b=document.getElementById("tooltip");let A=[],v=[],x=null,S=null,p=null,g=null,M=[],E=[];const j={1:"Bas-Saint-Laurent",2:"Saguenay-Lac-Saint-Jean",3:"Capitale-Nationale",4:"Mauricie",5:"Estrie",6:"Montréal",7:"Outaouais",8:"Abitibi-Témiscamingue",9:"Côte-Nord",10:"Nord du Québec (pas de données)",11:"Gaspésie-Îles-de-la-Madeleine",12:"Chaudière-Appalaches",13:"Laval",14:"Lanaudière",15:"Laurentides",16:"Montérégie",17:"Centre-du-Québec"},$={25:"Avis de vente impôt foncier",26:"Faillites",27:"Hypothèques construction",28:"Préavis d'exercice",29:"Saisies"},Y={1:"Janvier",2:"Février",3:"Mars",4:"Avril",5:"Mai",6:"Juin",7:"Juillet",8:"Août",9:"Septembre",10:"Octobre",11:"Novembre",12:"Décembre"};function q(){d3.json("../quebec-with-regions.geojson").then(o=>{y=o,u()}).catch(o=>console.error("Error loading GeoJSON data: ",o)),d3.csv("https://www.donneesquebec.ca/recherche/dataset/statistiques-du-registre-foncier-du-quebec-sur-le-marche-immobilier/resource/84ed216a-3284-4d05-aa85-d2ef30dd5d0f/download/donn_diff_fin_reqst.csv").then(o=>{const a=o.reduce((s,c)=>{const N=+c.DT_DEBUT_MOIS.substring(0,4),_=+c.DT_DEBUT_MOIS.substring(5,7),O=+c.ID_REGN_ADMIN,h=+c.CD_CATGR_NATR,f=+c.NB_REQST,d=s.find(n=>n.year===N&&n.month===_&&n.region===O);if(d){d.distressedPeople+=f;const n=d.categories.find(l=>l.category===h);n?n.distressedPeople+=f:d.categories.push({category:h,distressedPeople:f})}else s.push({year:N,month:_,region:O,distressedPeople:f,categories:[{category:h,distressedPeople:f}]});return s},[]);A=a,v=[...new Set(a.map(s=>s.year))],x=v[0],S=v[v.length-1];const e=[...new Set(a.map(s=>s.month))];p=e[0],g=e[e.length-1],H(),u()}).catch(o=>console.error("Error loading CSV data: ",o))}function u(){if(!y||A.length===0)return;B&&B.selectAll("*").remove(),console.log(y),console.log("HELLOOO"),console.log(A),console.log("HELLOO1");const o=new Date(x,p-1),a=new Date(S,g-1),e=A.filter(t=>{const i=new Date(t.year,t.month-1);return i>=o&&i<=a});if(e.length===0){console.log("NOT ENTERING DATA"),d3.select(I).selectAll("*").remove(),d3.select(L).selectAll("*").remove(),T.selectAll("*").remove(),B=d3.select("#messageSvg").attr("width",1200).attr("height",550).append("g").attr("transform","translate(500, 20)"),B.append("text").attr("text-anchor","middle").attr("font-size","16px").attr("fill","gray").text("Désolé, aucune donnée disponible pour la période ou les régions sélectionnées.");return}const s=550,c=550,N=d3.geoMercator().fitSize([s,c],y),_=d3.geoPath().projection(N);let O=0;const h={};y.features.forEach(t=>{const i=t.properties.res_co_reg,D=e.filter(r=>r.region===i);t.properties.totalDistressedPeople=D.reduce((r,R)=>r+R.distressedPeople,0);const w=D.reduce((r,R)=>(R.categories.forEach(C=>{r[C.category]||(r[C.category]=0),r[C.category]+=C.distressedPeople}),r),{});t.properties.categories=Object.keys(w).map(r=>({category:+r,distressedPeople:w[r]})),O+=t.properties.totalDistressedPeople,t.properties.categories.forEach(r=>{h[r.category]||(h[r.category]=0),h[r.category]+=r.distressedPeople})});const f=d3.max(y.features,t=>t.properties.totalDistressedPeople)||0,d=d3.scaleSequential().domain([0,f]).interpolator(d3.interpolateRgbBasis(["green","yellow","red"]));d3.select(I).selectAll("*").remove(),d3.select(L).selectAll("*").remove(),T=d3.select(I),T.attr("width",s).attr("height",c).attr("viewBox",`0 0 ${s} ${c}`),T.selectAll("path").data(y.features).enter().append("path").attr("d",_).attr("fill",t=>d(t.properties.totalDistressedPeople)).attr("stroke","#fff").attr("stroke-width",1).on("mouseover",function(t,i){const D=`<strong>${j[i.properties.res_co_reg]}</strong><br>
                  Total: ${i.properties.totalDistressedPeople}<br>
                  ${i.properties.categories.map(w=>`${$[w.category]}: ${w.distressedPeople}`).join("<br>")}`;b.innerHTML=D,b.style.visibility="visible"}).on("mousemove",function(t){b.style.top=t.pageY-75+"px",b.style.left=t.pageX-115+"px"}).on("mouseout",function(){b.style.visibility="hidden"});const n=800,l=60,m=d3.select(L).attr("width",n).attr("height",l);m.selectAll("*").remove(),m.append("defs").append("linearGradient").attr("id","legendGradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").selectAll("stop").data(d.ticks().map((t,i,D)=>({offset:`${100*i/D.length}%`,color:d(t)}))).enter().append("stop").attr("offset",t=>t.offset).attr("stop-color",t=>t.color),m.append("rect").attr("x",n*.3).attr("y",l/4).attr("width",n*.4).attr("height",l/3).style("fill","url(#legendGradient)");const z=d3.scaleLinear().domain(d.domain()).range([n*.3,n*.7]),k=d3.axisBottom(z).ticks(5).tickSize(-l/3);m.append("g").attr("transform",`translate(0, ${l/2+5})`).call(k).select(".domain").remove(),m.append("text").attr("x",n/2).attr("y",l-1).attr("text-anchor","middle").attr("class","mb-2").style("font-size","12px").text("Nombre total de détresses financières"),m.append("text").attr("x",n/3-50).attr("y",l/2).attr("text-anchor","end").style("font-size","12px").text("Faible"),m.append("text").attr("x",n-(n/3-50)).attr("y",l/2).attr("text-anchor","start").style("font-size","12px").text("Élevé")}function H(){const o=d3.select("#startYearSelect");o.selectAll("option").data(v).enter().append("option").attr("value",e=>e).text(e=>e),o.property("value",x),o.on("change",function(){x=+this.value,M=P(x),G(),u()});const a=d3.select("#endYearSelect");a.selectAll("option").data(v).enter().append("option").attr("value",e=>e).text(e=>e),a.property("value",S),a.on("change",function(){S=+this.value,E=P(S),G(),u()}),G()}function G(){M=P(x),E=P(S),(!p||M.indexOf(p)===-1)&&(p=M[0]),(!g||E.indexOf(g)===-1)&&(g=E[0]);const o=d3.select("#startMonthSelect");o.selectAll("option").data(M,e=>e).join("option").attr("value",e=>e).text(e=>Y[e]),o.property("value",p),o.on("change",function(){p=+this.value,u()});const a=d3.select("#endMonthSelect");a.selectAll("option").data(E,e=>e).join("option").attr("value",e=>e).text(e=>Y[e]),a.property("value",g),a.on("change",function(){g=+this.value,u()}),u()}function P(o){const a=A.filter(e=>e.year===o).map(e=>e.month);return[...new Set(a)]}q()});
