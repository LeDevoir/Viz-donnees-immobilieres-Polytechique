import"./styles-DoX-3eds.js";let b,A,E;function I(r,p,d){const u=document.getElementById("start-year"),s=document.getElementById("end-year"),g=document.getElementById("start-month"),n=document.getElementById("end-month");u.innerHTML="",s.innerHTML="",g.innerHTML="",n.innerHTML="";for(let l=p.getUTCFullYear();l<=d.getUTCFullYear();l++){const o=document.createElement("option");o.value=l,o.textContent=l,u.appendChild(o);const i=document.createElement("option");i.value=l,i.textContent=l,s.appendChild(i)}const a=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];a.forEach((l,o)=>{const i=document.createElement("option");i.value=o+1,i.textContent=l,g.appendChild(i);const h=document.createElement("option");h.value=o+1,h.textContent=l,n.appendChild(h)});function y(){const l=parseInt(s.value,10),o=parseInt(n.value,10),i=l===d.getUTCFullYear()?d.getUTCMonth()+1:12;n.innerHTML="";for(let h=0;h<i;h++){const x=document.createElement("option");x.value=h+1,x.textContent=a[h],n.appendChild(x)}o<=i?n.value=o:n.value=i}function m(){const l=parseInt(u.value,10),o=parseInt(s.value,10),i=parseInt(g.value,10),h=parseInt(n.value,10);r(l,o,i,h)}u.addEventListener("change",m),s.addEventListener("change",()=>{y(),m()}),g.addEventListener("change",m),n.addEventListener("change",m),u.value=p.getUTCFullYear(),s.value=d.getUTCFullYear(),g.value=p.getUTCMonth()+1,y(),s.value===d.getUTCFullYear().toString()&&(n.value=d.getUTCMonth()+1),m()}function w(r,p,d,u,s){return r.filter(g=>{const n=new Date(g.DT_DEBUT_MOIS),a=n.getUTCFullYear(),y=n.getUTCMonth()+1;return(a>p||a===p&&y>=u)&&(a<d||a===d&&y<=s)})}function D(r){if(r.length!=0){let M=function(){x=d3.stack().keys(g).order(d3.stackOrderNone).offset(d3.stackOffsetNone)(s),o.domain([0,d3.max(s,e=>d3.sum(n,c=>e[+c]))||0]).nice(),l.domain(s.map(e=>e.region));const f=b.selectAll(".price-range").data(x);f.exit().remove();const v=f.enter().append("g").attr("fill",e=>i(e.key)).attr("class",e=>`price-range price-range-${e.key}`).selectAll("rect").data(e=>e).enter().append("rect").attr("class","bar").attr("y",e=>l(e.data.region)).attr("height",l.bandwidth()*1.1);f.merge(v).selectAll("rect").data(e=>e).transition().attr("x",e=>{let c=e[0];return n.includes("1")||(c-=e.data[1]),!n.includes("2")&&c!==0&&(c-=e.data[2]),o(c)}).attr("width",e=>o(e[1])-o(e[0])),b.select(".x-axis").transition().call(d3.axisBottom(o).ticks(10,"s"))};const p={1:"Bas-Saint-Laurent",2:"Saguenay-Lac-Saint-Jean",3:"Capitale-Nationale",4:"Mauricie",5:"Estrie",6:"Montréal",7:"Outaouais",8:"Abitibi-Témiscamingue",9:"Côte-Nord",10:"Nord du Québec (pas de données)",11:"Gaspésie-Îles-de-la-Madeleine",12:"Chaudière-Appalaches",13:"Laval",14:"Lanaudière",15:"Laurentides",16:"Montérégie",17:"Centre-du-Québec"},d={1:"Moins de 250 000$",2:"Entre 250 000$ et 500 000$",3:"Plus de 500 000$"},u=d3.group(r,t=>t.ID_REGN_ADMIN),s=Array.from(u,([t,f])=>({region:p[t],...f.reduce((v,e)=>(v[e.CD_PLAGE_PRIX]=(v[e.CD_PLAGE_PRIX]||0)+e.NB_REQST,v),{})})),g=Array.from(new Set(r.map(t=>t.CD_PLAGE_PRIX.toString())));let n=Array.from(new Set(r.map(t=>t.CD_PLAGE_PRIX.toString())));const a={top:20,right:120,bottom:100,left:150};let y=1200-a.left-a.right,m=550-a.top-a.bottom;E=d3.select("#content-ventes").html("").append("svg").attr("width",y+a.left+a.right).attr("height",m+a.top+a.bottom).append("g").attr("transform","translate("+a.left+","+a.top+")"),b=E.append("g").attr("transform",`translate(${a.left},${a.top})`),E.append("text").attr("class","x-axis-label").attr("text-anchor","middle").attr("x",y/2).attr("y",m+80).text("Nombre d'achats par gamme de prix"),E.append("text").attr("class","y-axis-label").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("x",-m/2).attr("y",-30).text("Régions administratives du Québec");const l=d3.scaleBand().domain(s.map(t=>t.region)).range([0,m]).padding(.1);let o=d3.scaleLinear().domain([0,d3.max(s,t=>d3.sum(n,f=>t[+f]))||0]).nice().range([0,y]);const i=d3.scaleOrdinal().domain(n).range(d3.schemeCategory10);let x=d3.stack().keys(n).order(d3.stackOrderNone).offset(d3.stackOffsetNone)(s);const T=b.selectAll(".serie").data(x).enter().append("g").attr("fill",t=>i(t.key)).attr("class",t=>`price-range price-range-${t.key}`).selectAll("rect").data(t=>t).enter().append("rect").attr("y",t=>l(t.data.region)).attr("x",t=>o(t[0])).attr("height",l.bandwidth()*1.1).attr("width",t=>o(t[1])-o(t[0])).attr("class","bar");b.append("g").attr("class","x-axis").attr("transform",`translate(0,${m})`).call(d3.axisBottom(o).ticks(10,"s")),b.append("g").attr("class","y-axis").call(d3.axisLeft(l).tickFormat(t=>t));const C=d3.select("body").append("div").attr("class","absolute pointer-events-none p-2 rounded-lg bg-white border text-xs").style("visibility","hidden");T.on("mouseover",function(t,f){const v=f.data.region;d3.selectAll(".bar").filter(c=>c.data.region===v);const e=n.map(c=>({range:d[c],value:f.data[c]||0}));C.style("visibility","visible"),C.html(`
            <strong>${v}</strong><br>
            ${e.map(c=>`${c.range}: ${c.value}`).join("<br>")}
          `).style("left",t.pageX+15+"px").style("top",t.pageY-28+"px")}).on("mousemove",function(t){C.style("left",t.pageX+15+"px").style("top",t.pageY-28+"px")}).on("mouseout",function(){C.style("visibility","hidden")});const _=d3.select("#content-ventes").append("div").attr("class","legend-container-ventes").style("position","absolute");_.append("div").attr("class","legend-item").append("text").text("Cliquez pour modifier la visibilité").style("font-weight","bold"),g.forEach((t,f)=>{const v=_.append("div").attr("class",`legend-item legend-item-${t}`).style("cursor","pointer").on("mouseover",function(){d3.select(this).style("outline","1px solid black")}).on("mouseout",function(){d3.select(this).style("outline",null)}).on("click",function(){const e=d3.select(`.price-range-${t}`).style("display")==="none";d3.selectAll(`.price-range-${t}`).style("display",e?null:"none"),e?(n.push(t),d3.select(this).style("text-decoration",null)):(n=n.filter(c=>c!==t),d3.select(this).style("text-decoration","line-through")),M()});v.append("div").attr("style","display: inline-block; width: 15px; height: 15px;").style("background-color",i(t)),v.append("text").style("margin-left","10px").text(`${d[t]}`)})}else if(b.selectAll("*").remove(),E.selectAll("*").remove(),r.length===0){console.log("0 DATA !!!!"),E.append("text").attr("x",A/2).attr("y",height/2).attr("text-anchor","middle").attr("font-size","16px").attr("fill","gray").text("Désolé, aucune donnée disponible pour la période sélectionnée.");return}}d3.csv("https://www.donneesquebec.ca/recherche/dataset/statistiques-du-registre-foncier-du-quebec-sur-le-marche-immobilier/resource/d1ce4f2f-f5bc-492e-81a5-2347ed9c8c1a/download/donn_hypoth_reqst.csv",r=>({DT_DEBUT_MOIS:r.DT_DEBUT_MOIS,ID_REGN_ADMIN:+r.ID_REGN_ADMIN,CD_PLAGE_PRIX:+r.CD_PLAGE_PRIX,CD_NATR_ACTE_JURDQ:+r.CD_NATR_ACTE_JURDQ,NB_REQST:+r.NB_REQST})).then(r=>{const{minDate:p,maxDate:d}=L(r);I((u,s,g,n)=>{const a=w(r,u,s,g,n);D(a)},p,d),D(r)});function L(r){const p=r.map(s=>new Date(s.DT_DEBUT_MOIS)),d=new Date(Math.min(...p)),u=new Date(Math.max(...p));return{minDate:d,maxDate:u}}
